// Polkit rules for DVD Ripper Web Dashboard
// Allows dvd-web user to manage DVD ripper services without password
//
// Installation: /etc/polkit-1/rules.d/50-dvd-web.rules
//
// Services allowed:
//   - dvd-iso@*.service (ISO creation)
//   - dvd-encoder.service (encoding)
//   - dvd-encoder.timer
//   - dvd-distribute.service (cluster distribution)
//   - dvd-distribute.timer
//   - dvd-transfer.service (NAS transfer)
//   - dvd-transfer.timer
//   - dvd-archive.service (ISO archival)
//   - dvd-archive.timer
//   - dvd-audit.service (MKV audit)
//   - dvd-audit.timer
//   - dvd-ripper@*.service (legacy mode)
//   - dvd-dashboard.service (self-restart)
//   - dvd-udev-control@*.service (pause/resume udev trigger)

polkit.addRule(function(action, subject) {
    // Only apply to dvd-web user
    if (subject.user !== "dvd-web") {
        return polkit.Result.NOT_HANDLED;
    }

    // Allow managing systemd units
    if (action.id === "org.freedesktop.systemd1.manage-units") {
        var unit = action.lookup("unit");

        // Allow DVD ripper services
        if (unit && (
            unit.match(/^dvd-iso@.*\.service$/) ||
            unit === "dvd-encoder.service" ||
            unit === "dvd-encoder.timer" ||
            unit === "dvd-distribute.service" ||
            unit === "dvd-distribute.timer" ||
            unit === "dvd-transfer.service" ||
            unit === "dvd-transfer.timer" ||
            unit === "dvd-archive.service" ||
            unit === "dvd-archive.timer" ||
            unit === "dvd-audit.service" ||
            unit === "dvd-audit.timer" ||
            unit.match(/^dvd-ripper@.*\.service$/) ||
            unit === "dvd-dashboard.service" ||
            unit.match(/^dvd-udev-control@.*\.service$/)
        )) {
            return polkit.Result.YES;
        }
    }

    // Allow daemon-reload (needed after config changes)
    if (action.id === "org.freedesktop.systemd1.reload-daemon") {
        return polkit.Result.YES;
    }

    return polkit.Result.NOT_HANDLED;
});
