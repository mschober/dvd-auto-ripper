# DVD Ripper Configuration File
# Copy this file to /etc/dvd-ripper.conf and customize for your setup

# ============================================================================
# Storage Configuration
# ============================================================================

# Local staging directory for ripping DVDs before transfer to NAS
STAGING_DIR="/var/tmp/dvd-rips"

# ============================================================================
# Ripping Workflow Configuration
# ============================================================================

# Create ISO image from DVD (0=disabled, 1=enabled)
# When enabled, creates an ISO file from the DVD first using ddrescue
# Useful for damaged discs or archival purposes
CREATE_ISO="0"

# Encode video from DVD/ISO (0=disabled, 1=enabled)
# When enabled, encodes to compressed video file using HandBrake
# If CREATE_ISO=1, encodes from ISO; otherwise encodes directly from DVD
ENCODE_VIDEO="1"

# ============================================================================
# NAS Configuration
# ============================================================================

# Enable or disable NAS transfer (0=disabled, 1=enabled)
# When disabled, files remain in STAGING_DIR after ripping
NAS_ENABLED="0"

# NAS hostname or IP address
# Example: NAS_HOST="192.168.0.100"
NAS_HOST=""

# NAS username for file transfer
# Note: Configure SSH key-based authentication for passwordless access
# Example: NAS_USER="media"
NAS_USER=""

# Destination path on NAS for DVD files
# Example: NAS_PATH="/volume1/media/movies"
NAS_PATH=""

# Transfer method: "rsync" or "scp"
# rsync is recommended for resume capability and progress tracking
NAS_TRANSFER_METHOD="rsync"

# File ownership after transfer (user:group)
# After transfer, files are chown'd to this owner on the NAS
# Set to empty string to skip ownership change
# Example: NAS_FILE_OWNER="plex:plex"
NAS_FILE_OWNER="plex:plex"

# SSH identity file for NAS connection (v2.0 user isolation)
# Used by the dvd-transfer user for rsync/scp/ssh commands
# Generated automatically during installation
# Leave empty to use default SSH key discovery
NAS_SSH_IDENTITY="/var/lib/dvd-transfer/.ssh/id_ed25519"

# ============================================================================
# DVD Device Configuration
# ============================================================================

# DVD drive device path
# Most systems use /dev/sr0, but check with: lsblk
DVD_DEVICE="/dev/sr0"

# ============================================================================
# HandBrake Encoding Settings
# ============================================================================

# HandBrake preset to use for encoding
# Common presets:
#   - "Fast 1080p30" - Quick encode, good quality (recommended)
#   - "HQ 1080p30 Surround" - Higher quality, slower
#   - "Super HQ 1080p30 Surround" - Highest quality, very slow
#   - "Very Fast 1080p30" - Fastest, lower quality
# List all presets: HandBrakeCLI --preset-list
HANDBRAKE_PRESET="Fast 1080p30"

# Quality setting (lower = better quality, larger file)
# Recommended range: 18-22
# 18 = High quality, ~5-8GB per movie
# 20 = Good quality, ~3-5GB per movie (recommended)
# 22 = Acceptable quality, ~2-3GB per movie
HANDBRAKE_QUALITY="20"

# Output format: "mkv" or "mp4"
# mkv = Matroska, more flexible, supports more formats
# mp4 = MP4, better device compatibility
HANDBRAKE_FORMAT="mkv"

# Minimum acceptable file size in MB
# Used to verify rip completed successfully (not corrupted/partial)
MIN_FILE_SIZE_MB="100"

# ============================================================================
# Logging Configuration
# ============================================================================

# Log file location
LOG_FILE="/var/log/dvd-ripper.log"

# Log level: DEBUG, INFO, WARN, ERROR
# DEBUG = Verbose output for troubleshooting
# INFO = Normal operation messages (recommended)
# WARN = Only warnings and errors
# ERROR = Only errors
LOG_LEVEL="INFO"

# ============================================================================
# Lock File Configuration
# ============================================================================

# Lock/PID file to prevent multiple simultaneous rips
# /run/dvd-ripper/ is created by systemd RuntimeDirectory
LOCK_FILE="/run/dvd-ripper/dvd-ripper.pid"

# ============================================================================
# Retry Configuration
# ============================================================================

# Maximum number of retry attempts for failed operations
MAX_RETRIES="3"

# Delay between retry attempts (seconds)
RETRY_DELAY="60"

# ============================================================================
# Email Notification (Optional - Future Enhancement)
# ============================================================================

# Enable email notifications (0=disabled, 1=enabled)
# NOTIFY_EMAIL="0"

# Email address for notifications
# NOTIFY_EMAIL_TO=""

# Email subject prefix
# NOTIFY_EMAIL_SUBJECT="[DVD Ripper]"

# ============================================================================
# Pipeline Mode Configuration
# ============================================================================
# The 3-stage pipeline separates DVD processing into independent steps:
#   Stage 1 (udev trigger): Create ISO from DVD, eject immediately
#   Stage 2 (cron/timer):   Encode ISO to video (15 min intervals)
#   Stage 3 (cron/timer):   Transfer video to NAS (15 min intervals)
#
# Benefits: Drive is freed quickly, encoding happens in background

# Enable pipeline mode (0=monolithic single-process, 1=3-stage pipeline)
# When enabled, dvd-iso.sh handles disc insertion, dvd-encoder.sh and
# dvd-transfer.sh run via systemd timers
PIPELINE_MODE="1"

# Stage-specific lock files (pipeline mode)
ISO_LOCK_FILE="/run/dvd-ripper/iso.lock"
ENCODER_LOCK_FILE="/run/dvd-ripper/encoder.lock"
TRANSFER_LOCK_FILE="/run/dvd-ripper/transfer.lock"
DISTRIBUTE_LOCK_FILE="/run/dvd-ripper/distribute.lock"

# Event-driven triggers (pipeline mode)
# When enabled, each stage automatically triggers the next stage via systemctl
# instead of waiting for the next timer interval. Reduces latency between stages.
# Default: 0 (disabled - use polling timers)
TRIGGER_NEXT_STAGE="0"

# Cleanup settings (pipeline mode)
# Delete local MKV after successful NAS transfer
CLEANUP_MKV_AFTER_TRANSFER="1"
# Delete ISO after successful NAS transfer (ISO marked .deletable after encode)
CLEANUP_ISO_AFTER_TRANSFER="1"

# Disk usage threshold (percentage) - skip ripping if disk is too full
DISK_USAGE_THRESHOLD="80"

# Delete preview after successful NAS transfer (0=keep for identification, 1=delete)
# Preview files are kept by default to allow identification of generic-named movies
CLEANUP_PREVIEW_AFTER_TRANSFER="0"

# ============================================================================
# Parallel Encoding Configuration
# ============================================================================
# Enable parallel encoding to run multiple HandBrake instances simultaneously
# based on system load. Useful for multi-core systems with multiple DVDs queued.
#
# When enabled, the encoder uses numbered lock files instead of a single lock:
#   /run/dvd-ripper/encoder-1.lock
#   /run/dvd-ripper/encoder-2.lock
#   etc.

# Enable parallel encoding (0=disabled/single encoder, 1=enabled)
# Default: disabled for safety - enable after testing on your system
ENABLE_PARALLEL_ENCODING="0"

# Maximum number of concurrent encoding processes
# Recommended: 1-2 for quad-core, 2-4 for 8+ cores
# Each HandBrake instance typically uses 100-200% CPU
MAX_PARALLEL_ENCODERS="2"

# Load threshold per CPU core before starting new encoders
# Value 0.0-1.0 multiplied by CPU count gives max load average
# Example: 0.8 on 4-core system = don't start if load > 3.2
# Lower = more conservative, higher = more aggressive
ENCODER_LOAD_THRESHOLD="0.8"

# ============================================================================
# Transfer Mode Configuration
# ============================================================================
# Control how encoded videos are transferred to their final destination.
# "remote" = rsync/scp to NAS (existing behavior, uses NAS_HOST settings)
# "local"  = move file to local path (for machines that ARE the media server)

# Transfer mode: "remote" or "local"
TRANSFER_MODE="remote"

# For local mode: destination path for encoded videos
# Only used when TRANSFER_MODE="local"
# Example for Plex: "/volume1/media/movies" or "/mnt/plex/Movies"
LOCAL_LIBRARY_PATH=""

# ============================================================================
# Cluster Configuration
# ============================================================================
# Enable distributed encoding across multiple machines. Each machine in the
# cluster can rip DVDs and/or encode. When one machine is busy, it can send
# ISOs to peers for encoding.
#
# Requires: SSH key auth between cluster nodes, same software on all nodes

# Enable cluster mode (0=standalone, 1=cluster member)
CLUSTER_ENABLED="0"

# This machine's hostname/identifier in cluster
CLUSTER_NODE_NAME=""

# Peer nodes (space-separated "name:host:port" entries)
# Example: "plex:192.168.1.50:5000 cart:192.168.1.34:5000"
CLUSTER_PEERS=""

# SSH user for rsync transfers between cluster nodes
CLUSTER_SSH_USER=""

# Remote staging directory on peer nodes (where ISOs are sent)
CLUSTER_REMOTE_STAGING="/var/tmp/dvd-rips"

# ============================================================================
# Preview Generation Configuration
# ============================================================================
# Previews are short video clips extracted during encoding to help identify
# DVDs that have generic/fallback names (e.g., "DVD_20251227_143022")
# These are viewable in the dashboard's "Pending Identification" page

# Enable preview generation (0=disabled, 1=enabled)
# Requires ffmpeg and ffprobe to be installed
GENERATE_PREVIEWS="1"

# Preview duration in seconds (default: 120 = 2 minutes)
PREVIEW_DURATION="120"

# Start position as percentage into video (default: 25)
# Setting to 25 starts the preview 1/4 into the movie, past intro commercials
PREVIEW_START_PERCENT="25"

# Preview resolution in ffmpeg scale format (default: 640:360 = 360p)
# Lower resolution = smaller files, faster generation
# Options: 640:360 (360p), 854:480 (480p), 1280:720 (720p)
PREVIEW_RESOLUTION="640:360"

# ============================================================================
# Advanced Options
# ============================================================================

# Device ready timeout (seconds)
# How long to wait for DVD drive to recognize disc
DEVICE_TIMEOUT="30"

# Additional HandBrake options (optional)
# Example: HANDBRAKE_EXTRA_OPTS="--all-audio --all-subtitles"
# Memory-saving options for systems with limited RAM:
#   --encoder-preset veryfast    - Use faster, less memory-intensive encoder
#   --vfr                        - Variable frame rate (reduces memory)
# Error recovery options for damaged/protected DVDs:
#   --no-dvdnav                  - Use libdvdread instead of libdvdnav (better error handling)
# Default: Low memory preset with error recovery for stability
# HANDBRAKE_EXTRA_OPTS="--encoder-preset veryfast --vfr --no-dvdnav"
